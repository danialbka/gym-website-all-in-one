<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GymRank - Competitive Lifting Platform</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèãÔ∏è</text></svg>">
  <!-- Critical CSS inlined directly to avoid caching issues -->
  <style id="critical-css">
    /* CSS Variables - Essential for theming */
    :root {
      --primary-color: #ea580c;
      --primary-dark: #c2410c;
      --primary-light: #fed7aa;
      --secondary-color: #1f2937;
      --secondary-light: #374151;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --background: #ffffff;
      --background-alt: #f9fafb;
      --border: #e5e7eb;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    
    .dark {
      --primary-color: #ea580c;
      --primary-dark: #c2410c;
      --primary-light: #fed7aa;
      --secondary-color: #f9fafb;
      --secondary-light: #e5e7eb;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --background: #111827;
      --background-alt: #1f2937;
      --border: #374151;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    
    /* Reset and base styles */
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--background);
    }
    
    /* Navigation - Always visible */
    .navbar {
      background-color: var(--background);
      border-bottom: 2px solid var(--border);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* Navigation links - Immediate styling */
    .nav-link {
      color: var(--text-primary) !important;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: all 0.2s ease;
      background: transparent;
      border: 1px solid transparent;
      font-weight: 500;
      position: relative;
    }
    
    .nav-link:hover {
      background-color: var(--background-alt);
      color: var(--primary-color) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(234, 88, 12, 0.15);
    }
    
    .nav-link.active {
      background-color: var(--primary-color);
      color: black !important;
      box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
      font-weight: 600;
    }

    .dark .nav-link.active {
      color: white !important;
    }
    
    

    /* Leaderboard item hover effects */
    .leaderboard-item {
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }
    
    .leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
      background: linear-gradient(135deg, var(--background-alt) 0%, var(--background) 100%);
    }
    
    .leaderboard-item:hover .rank-number {
      color: var(--primary-color) !important;
      font-weight: 700;
    }

    /* Team leaderboard item hover effects */
    .team-leaderboard-item {
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }
    
    .team-leaderboard-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
      background: linear-gradient(135deg, var(--background-alt) 0%, var(--background) 100%);
    }

    /* Tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: var(--secondary-color);
      color: var(--background);
      text-align: center;
      border-radius: 6px;
      padding: 5px 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: var(--secondary-color) transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext { visibility: hidden; opacity: 0; }

    /* Team member item hover effects */
    .team-member-item {
      transition: all 0.2s ease;
    }
    
    .team-member-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color) !important;
    }

    /* Video card enhancements */
    .video-card {
      transition: all 0.3s ease;
    }
    
    .video-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .instagram-embed-placeholder {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      transition: all 0.2s ease;
    }

    .instagram-embed-placeholder:hover {
      transform: scale(1.02);
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
    }
    
    /* Loading states */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      left: -10000px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    .skip-link:focus {
      left: 1rem;
      top: 1rem;
      width: auto;
      height: auto;
      padding: 0.5rem 0.75rem;
      background: var(--primary-color);
      color: white;
      border-radius: 0.375rem;
      z-index: 1000;
    }
    /* Back-to-top button */
    #back-to-top {
      position: fixed;
      right: 1rem;
      bottom: 1rem;
      display: none;
      border-radius: 9999px;
      padding: 0.6rem 0.75rem;
      background: var(--primary-color);
      color: black;
      border: none;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      cursor: pointer;
    }
    @media (prefers-reduced-motion: reduce) {
      * { scroll-behavior: auto !important; }
    }
  </style>
  <link href="./src/output.css" rel="stylesheet">
  
  <!-- Load essential scripts only -->
  <script src="./src/device-detection.js"></script>
</head>
<body class="min-h-screen">
  <!-- Navigation Header -->
  <a href="#main" class="skip-link">Skip to content</a>
  <nav class="navbar">
    <div class="container">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
          <h1 class="navbar-brand">üèãÔ∏è GymRank</h1>
        </div>
        <div class="navbar-nav flex items-center">
          <button onclick="showSection('home')" id="nav-home" class="nav-link active" aria-label="Go to home page" title="Home - Dashboard and PR submission">
            üè† Home
          </button>
          <button onclick="showSection('videos')" id="nav-videos" class="nav-link" aria-label="View PR videos" title="Videos - Watch community PRs">
            üìπ Videos
          </button>
          <button onclick="showSection('leaderboard')" id="nav-leaderboard" class="nav-link" aria-label="View leaderboard rankings" title="Leaderboard - DOTS rankings">
            üèÜ Leaderboard
          </button>
          <button onclick="showSection('teams')" id="nav-teams" class="nav-link" aria-label="View team rankings" title="Teams - Team competitions">
            üèüÔ∏è Teams
          </button>
          <div id="user-info" class="hidden nav-link" onclick="showSection('profile')" aria-label="View your profile" style="display: flex; align-items: center;">
            <div id="logged-in-user" class="flex items-center gap-2"></div>
          </div>
          <button id="logout-btn" onclick="logout()" class="hidden btn btn-outline btn-sm" aria-label="Sign out of your account" title="Sign out">
            Logout
          </button>
          <button id="theme-toggle" onclick="toggleTheme()" class="btn btn-ghost btn-icon" aria-label="Toggle between light and dark theme">
            <span id="theme-icon">üåô</span>
          </button>
          <button onclick="switchToMobile()" class="btn btn-ghost btn-sm" aria-label="Switch to mobile view">
            üì±
          </button>
          <div id="auth-buttons" class="flex items-center gap-2">
            <button onclick="showLoginModal()" class="btn btn-outline" aria-label="Sign in to your account">
              Login
            </button>
            <button onclick="showRegisterModal()" class="btn btn-primary" aria-label="Create a new account">
              Register
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div id="main" class="container" style="padding-top: 2rem;">
    <!-- Home Section -->
    <div id="home-section" class="section" style="padding-top: 1rem;">
      <!-- Hero Section -->
      <section class="hero mb-8">
        <div class="container">
          <div class="flex items-center justify-between" style="gap: 1.25rem; flex-wrap: wrap;">
            <div style="flex: 1 1 420px; min-width: 280px;">
              <h2 class="hero-title mb-2">
                Compete. Improve. <span class="gradient-text">Rank Up</span>.
              </h2>
              <p class="hero-subtitle mb-4">
                Track your PRs, watch elite lifts, and climb the DOTS leaderboard. Built for lifters who love progress.
              </p>
              <div class="flex items-center" style="gap: 0.75rem; flex-wrap: wrap;">
                <button onclick="showRegisterModal()" class="btn btn-gradient btn-lg">üöÄ Get Started</button>
                <button onclick="showSection('leaderboard')" class="btn btn-outline btn-lg">üèÜ View Leaderboard</button>
              </div>
            </div>
            <div class="card" style="flex: 1 1 340px; min-width: 260px;">
              <div class="flex" style="gap: 1rem; align-items: center;">
                <div class="text-4xl" aria-hidden="true">üìà</div>
                <div>
                  <div class="font-semibold">Live Rankings</div>
                  <div style="color: var(--text-secondary);">Auto-updated DOTS and team scores</div>
                </div>
              </div>
              <div class="flex mt-4" style="gap: 1rem; align-items: center;">
                <div class="text-4xl" aria-hidden="true">üìπ</div>
                <div>
                  <div class="font-semibold">Verified PRs</div>
                  <div style="color: var(--text-secondary);">Submit Instagram-linked lifts with ease</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">Welcome to GymRank</h2>
        <p style="color: var(--text-secondary)">Competitive lifting platform inspired by Bakugan rankings</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 stats-cards">
        <div class="card">
          <h3 class="font-semibold text-lg mb-2">Total Lifters</h3>
          <p class="text-3xl font-bold" style="color: var(--primary-color)" id="total-users">-</p>
        </div>
        <div class="card">
          <h3 class="font-semibold text-lg mb-2">Total PRs</h3>
          <p class="text-3xl font-bold" style="color: var(--primary-color)" id="total-prs">-</p>
        </div>
        <div class="card">
          <h3 class="font-semibold text-lg mb-2">Top DOTS</h3>
          <p class="text-3xl font-bold" style="color: var(--primary-color)" id="top-elo">-</p>
        </div>
      </div>

      <!-- PR Submission Section (Only for logged-in users) -->
      <div id="pr-section" class="card hidden">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-semibold mb-2">ü•á Prove Your Strength</h2>
          <p style="color: var(--text-secondary)">Submit your personal best and rise through the leaderboard!</p>
        </div>
        
        <form id="combined-pr-form" enctype="multipart/form-data">
          <div class="form-group">
            <label class="form-label">Lift Type</label>
            <select id="lift-type" class="form-input">
              <option value="bench">Bench Press</option>
              <option value="deadlift">Deadlift</option>
              <option value="squat">Squat</option>
            </select>
          </div>
          <div class="form-group">
            <label for="weight" class="form-label">Weight (kg)</label>
            <input 
              type="number" 
              id="weight" 
              name="weight"
              class="form-input" 
              placeholder="Enter weight in kg" 
              step="0.5" 
              min="1" 
              max="600" 
              required
              aria-describedby="weight-help"
            >
            <p id="weight-help" class="text-sm" style="color: var(--text-secondary); margin-top: 0.25rem">Enter your PR weight in kilograms (1-600kg)</p>
          </div>
          <div class="form-group">
            <label for="instagram-url" class="form-label">Instagram Video Link (Required)</label>
            <input 
              type="url" 
              id="instagram-url" 
              name="instagram-url"
              class="form-input" 
              placeholder="https://www.instagram.com/reel/..." 
              required
              aria-describedby="instagram-help"
              pattern="https://www\.instagram\.com/(reel|p|tv)/.*"
            >
            <p id="instagram-help" class="text-sm" style="color: var(--text-secondary); margin-top: 0.25rem">Required: Instagram reel, post, or IGTV link ‚Ä¢ Must be a valid Instagram URL</p>
          </div>
          <button type="submit" class="btn btn-primary w-full btn-lg">
            Submit PR
          </button>
        </form>
      </div>

      <!-- Welcome Message for Non-logged-in Users -->
      <div id="welcome-section" class="card text-center">
        <h2 class="text-2xl font-semibold mb-4">Welcome to GymRank!</h2>
        <p class="mb-6" style="color: var(--text-secondary)">Join the competitive lifting platform inspired by Bakugan rankings</p>
        <div class="flex justify-center gap-4">
          <button onclick="showRegisterModal()" class="btn btn-gradient btn-lg">
            Get Started
          </button>
          <button onclick="showLoginModal()" class="btn btn-outline btn-lg">
            Sign In
          </button>
        </div>
      </div>
    </div>

    <!-- Videos Section -->
    <div id="videos-section" class="section hidden" style="padding-top: 1rem;">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üìπ PR Videos</h2>
        <p style="color: var(--text-secondary)">Watch incredible lifts from our community</p>
      </div>
      
      <div id="videos-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-6 videos-grid-mobile">
        <div class="flex justify-center items-center py-8 col-span-full">
          <div class="dot-matrix-spinner">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaderboard Section -->
    <div id="leaderboard-section" class="section hidden" style="padding-top: 1rem;">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üèÜ Leaderboard</h2>
        <p style="color: var(--text-secondary)">Top lifters ranked by DOTS score (Bodyweight adjusted)</p>
      </div>
      
      <!-- Filter Controls -->
      <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
        <!-- Gender Filter Buttons -->
        <div class="flex gap-2">
          <button onclick="setActiveFilter('all'); loadLeaderboard('', currentCountryFilter);" id="filter-all" class="btn btn-primary">
            All
          </button>
          <button onclick="setActiveFilter('male'); loadLeaderboard('male', currentCountryFilter);" id="filter-male" class="btn btn-outline">
            ‚ôÇÔ∏è Men
          </button>
          <button onclick="setActiveFilter('female'); loadLeaderboard('female', currentCountryFilter);" id="filter-female" class="btn btn-outline">
            ‚ôÄÔ∏è Women
          </button>
        </div>
        
        <!-- Country Filter Dropdown -->
        <div class="flex items-center gap-2">
          <label for="country-filter" class="text-sm font-medium" style="color: var(--text-secondary)">Country:</label>
          <select id="country-filter" onchange="filterByCountry(this.value)" class="form-input">
            <option value="">All Countries</option>
            <option value="üá∫üá∏">üá∫üá∏ United States</option>
            <option value="üá¨üáß">üá¨üáß United Kingdom</option>
            <option value="üá®üá¶">üá®üá¶ Canada</option>
            <option value="üá¶üá∫">üá¶üá∫ Australia</option>
            <option value="üá©üá™">üá©üá™ Germany</option>
            <option value="üá´üá∑">üá´üá∑ France</option>
            <option value="üáØüáµ">üáØüáµ Japan</option>
            <option value="üá∞üá∑">üá∞üá∑ South Korea</option>
            <option value="üá®üá≥">üá®üá≥ China</option>
            <option value="üáÆüá≥">üáÆüá≥ India</option>
            <option value="üáßüá∑">üáßüá∑ Brazil</option>
            <option value="üá≤üáΩ">üá≤üáΩ Mexico</option>
            <option value="üá∑üá∫">üá∑üá∫ Russia</option>
            <option value="üáÆüáπ">üáÆüáπ Italy</option>
            <option value="üá™üá∏">üá™üá∏ Spain</option>
            <option value="üá≥üá±">üá≥üá± Netherlands</option>
            <option value="üá∏üá™">üá∏üá™ Sweden</option>
            <option value="üá≥üá¥">üá≥üá¥ Norway</option>
            <option value="üá©üá∞">üá©üá∞ Denmark</option>
            <option value="üá´üáÆ">üá´üáÆ Finland</option>
            <option value="üá∏üá¨">üá∏üá¨ Singapore</option>
            <option value="üá≠üá∞">üá≠üá∞ Hong Kong</option>
            <option value="üáπüáº">üáπüáº Taiwan</option>
            <option value="üáπüá≠">üáπüá≠ Thailand</option>
            <option value="üá≤üáæ">üá≤üáæ Malaysia</option>
            <option value="üáÆüá©">üáÆüá© Indonesia</option>
            <option value="üáµüá≠">üáµüá≠ Philippines</option>
            <option value="üáªüá≥">üáªüá≥ Vietnam</option>
            <option value="üáøüá¶">üáøüá¶ South Africa</option>
            <option value="üá≥üá¨">üá≥üá¨ Nigeria</option>
            <option value="üá™üá¨">üá™üá¨ Egypt</option>
          </select>
        </div>
      </div>
      
      <div class="card">
        <div id="leaderboard" class="space-y-3">
          <div class="flex justify-center items-center py-8">
            <div class="dot-matrix-spinner">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Teams Section -->
    <div id="teams-section" class="section hidden" style="padding-top: 1rem;">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üèüÔ∏è Team Competition</h2>
        <p style="color: var(--text-secondary)">Team rankings and competitions</p>
      </div>
      
      <!-- Search and Filter Controls -->
      <div class="mb-6">
        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
          <div class="flex-1 max-w-md">
            
            <div class="relative">
              <input
                type="text"
                id="team-search"
                class="form-input pl-4 pr-4"
                placeholder="Search teams by name..."
                aria-label="Search teams"
                oninput="filterTeams()"
              >
            </div>
          </div>
          <div class="flex items-center gap-2">
            <label for="team-sort" class="text-sm font-medium" style="color: var(--text-secondary)">Sort by:</label>
            <select id="team-sort" class="form-input" onchange="sortTeams(this.value)">
              <option value="avg_elo">Average ELO</option>
              <option value="member_count">Member Count</option>
              <option value="top_elo">Top ELO</option>
              <option value="total_elo">Total ELO</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div id="team-leaderboard" class="space-y-3">
          <div class="flex justify-center items-center py-8">
            <div class="dot-matrix-spinner">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Detail Section -->
    <div id="team-detail-section" class="section hidden" style="padding-top: 1rem;">
      <div class="container mx-auto px-4 py-8">
        <!-- Breadcrumb Navigation -->
        <nav aria-label="Breadcrumb" class="mb-6">
          <div class="flex items-center gap-2 text-sm">
            <button onclick="showSection('home', true, false)" class="text-primary hover:underline" style="color: var(--primary-color)">
              üè† Home
            </button>
            <span style="color: var(--text-secondary)">‚Ä∫</span>
            <button onclick="showSection('teams', true, false)" class="text-primary hover:underline" style="color: var(--primary-color)">
              üèüÔ∏è Teams
            </button>
            <span style="color: var(--text-secondary)">‚Ä∫</span>
            <span id="team-detail-name" style="color: var(--text-secondary)">
              Team Details
            </span>
          </div>
        </nav>

        <!-- Back Button -->
        <div class="mb-6">
          <button onclick="showSection('teams', true, false)" class="btn btn-outline" aria-label="Go back to teams">
            ‚Üê Back to Teams
          </button>
        </div>

        <!-- Loading State -->
        <div id="team-detail-loading" class="flex flex-col items-center justify-center py-16">
          <div class="dot-matrix-spinner mb-4">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
          <p style="color: var(--text-secondary)">Loading team details...</p>
        </div>

        <!-- Error State -->
        <div id="team-detail-error" class="hidden flex flex-col items-center justify-center py-16">
          <div class="text-6xl mb-4">üòµ</div>
          <h2 class="text-2xl font-bold mb-2">Team Not Found</h2>
          <p style="color: var(--text-secondary)" class="mb-6">The team you're looking for doesn't exist.</p>
          <button onclick="showSection('teams', true, false)" class="btn btn-primary btn-lg">
            Go Back to Teams
          </button>
        </div>

        <!-- Team Content -->
        <div id="team-detail-content" class="hidden">
          <!-- Team Header -->
          <div class="card mb-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <span class="text-6xl">üèüÔ∏è</span>
                <div>
                  <h1 id="team-detail-title" class="text-3xl font-bold"></h1>
                  <p id="team-detail-member-count" style="color: var(--text-secondary)" class="text-lg"></p>
                </div>
              </div>
              <div class="text-right">
                <div id="team-detail-rank" class="text-lg font-bold" style="color: var(--primary-color)"></div>
                <div class="text-sm" style="color: var(--text-secondary)">Team Rank</div>
              </div>
            </div>
          </div>

          <!-- Team Stats -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card text-center">
              <div class="text-4xl mb-3">üìä</div>
              <div style="color: var(--text-secondary)" class="mb-2">Average ELO</div>
              <div id="team-detail-avg-elo" class="text-3xl font-bold" style="color: var(--primary-color)"></div>
            </div>
            <div class="card text-center">
              <div class="text-4xl mb-3">üèÜ</div>
              <div style="color: var(--text-secondary)" class="mb-2">Top ELO</div>
              <div id="team-detail-top-elo" class="text-3xl font-bold" style="color: var(--success)"></div>
            </div>
            <div class="card text-center">
              <div class="text-4xl mb-3">üë•</div>
              <div style="color: var(--text-secondary)" class="mb-2">Members</div>
              <div id="team-detail-members" class="text-3xl font-bold" style="color: var(--info)"></div>
            </div>
            <div class="card text-center">
              <div class="text-4xl mb-3">üí™</div>
              <div style="color: var(--text-secondary)" class="mb-2">Total ELO</div>
              <div id="team-detail-total-elo" class="text-3xl font-bold" style="color: var(--warning)"></div>
            </div>
          </div>

          <!-- Members List -->
          <div class="card">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
              <span>üë•</span>
              Team Members
            </h2>
            <div id="team-detail-members-list" class="space-y-2">
              <!-- Members will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Profile Section -->
    <div id="profile-section" class="section hidden" style="padding-top: 1rem;">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-2">üë§ My Profile</h2>
        <p style="color: var(--text-secondary)">Manage your posts and profile settings</p>
      </div>
      
      <!-- Progress Charts -->
      <div class="mb-8">
        <div class="card">
          <h3 class="text-xl font-bold mb-6">üìà Progress Charts</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Bench Press Chart -->
            <div class="card">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">üèãÔ∏è</span>
                  <div>
                    <h4 class="font-semibold">Bench Press</h4>
                    <p class="text-sm" style="color: var(--text-secondary)" id="bench-current">Current: --kg</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs" style="color: var(--text-secondary)">Trend</div>
                  <div id="bench-trend" class="text-sm font-semibold">--</div>
                </div>
              </div>
              <div class="relative" style="height: 240px;">
                <canvas id="bench-chart" class="w-full h-full"></canvas>
              </div>
            </div>
            
            <!-- Squat Chart -->
            <div class="card">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">ü¶µ</span>
                  <div>
                    <h4 class="font-semibold">Squat</h4>
                    <p class="text-sm" style="color: var(--text-secondary)" id="squat-current">Current: --kg</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs" style="color: var(--text-secondary)">Trend</div>
                  <div id="squat-trend" class="text-sm font-semibold">--</div>
                </div>
              </div>
              <div class="relative" style="height: 240px;">
                <canvas id="squat-chart" class="w-full h-full"></canvas>
              </div>
            </div>
            
            <!-- Deadlift Chart -->
            <div class="card">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                  <div>
                    <h4 class="font-semibold">Deadlift</h4>
                    <p class="text-sm" style="color: var(--text-secondary)" id="deadlift-current">Current: --kg</p>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs" style="color: var(--text-secondary)">Trend</div>
                  <div id="deadlift-trend" class="text-sm font-semibold">--</div>
                </div>
              </div>
              <div class="relative" style="height: 240px;">
                <canvas id="deadlift-chart" class="w-full h-full"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Profile Settings -->
        <div class="lg:col-span-1">
          <div class="card">
            <h3 class="text-xl font-bold mb-4">Profile Settings</h3>
            
            <form id="profile-settings-form">
              <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="profile-username" class="form-input" placeholder="Username">
                <p class="text-xs" style="color: var(--text-secondary); margin-top: 0.25rem">Your display name</p>
              </div>
              
              <div class="form-group">
                <label class="form-label">Team/Gym</label>
                <input type="text" id="profile-team" class="form-input" placeholder="Enter your team/gym name">
              </div>
              
              <div class="form-group">
                <label class="form-label">Weight (kg)</label>
                <input type="number" id="profile-weight" class="form-input" placeholder="Enter your weight in kg" step="0.1" min="0">
                <p class="text-xs" style="color: var(--text-secondary); margin-top: 0.25rem">Your current body weight</p>
              </div>
              
              <div class="form-group">
                <label class="form-label">Gender</label>
                <select id="profile-gender" class="form-input" required>
                  <option value="">Select gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
                <p class="text-xs" style="color: var(--text-secondary); margin-top: 0.25rem">Required for DOTS score calculation</p>
              </div>
              
              <button type="submit" class="btn btn-primary w-full">
                Update Profile
              </button>
            </form>
          </div>
        </div>
        
        <!-- My Posts -->
        <div class="lg:col-span-2">
          <div class="card">
            <h3 class="text-xl font-bold mb-4">My Posts</h3>
            <div id="user-posts" class="space-y-4">
              <div class="flex justify-center items-center py-8">
                <div class="dot-matrix-spinner">
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                  <div class="dot"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Profile View Section (for viewing other users) -->
  <div id="user-profile-section" class="section hidden" style="padding-top: 1rem;">
    <div class="container mx-auto px-4 py-8">
      <!-- Breadcrumb Navigation -->
      <nav aria-label="Breadcrumb" class="mb-6">
        <div class="flex items-center gap-2 text-sm">
          <button onclick="showSection('home', true, false)" class="text-primary hover:underline" style="color: var(--primary-color)">
            üè† Home
          </button>
          <span style="color: var(--text-secondary)">‚Ä∫</span>
          <span id="breadcrumb-section" class="text-primary hover:underline cursor-pointer" style="color: var(--primary-color)">
            Leaderboard
          </span>
          <span style="color: var(--text-secondary)">‚Ä∫</span>
          <span id="breadcrumb-username" style="color: var(--text-secondary)">
            User Profile
          </span>
        </div>
      </nav>

      <!-- Back Button -->
      <div class="mb-6">
        <button onclick="goBackToPrevious()" class="btn btn-outline" aria-label="Go back to previous page">
          ‚Üê Back to <span id="back-button-text">Previous</span>
        </button>
      </div>

      <!-- Loading State -->
      <div id="user-profile-loading" class="flex flex-col items-center justify-center py-16">
        <div class="dot-matrix-spinner mb-4">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
        <p style="color: var(--text-secondary)">Loading profile...</p>
      </div>

      <!-- Error State -->
      <div id="user-profile-error" class="hidden flex flex-col items-center justify-center py-16">
        <div class="text-6xl mb-4">üòµ</div>
        <h2 class="text-2xl font-bold mb-2">Profile Not Found</h2>
        <p style="color: var(--text-secondary)" class="mb-6">The user profile you're looking for doesn't exist.</p>
        <button onclick="goBackToPrevious()" class="btn btn-primary btn-lg">
          Go Back
        </button>
      </div>

      <!-- Profile Content -->
      <div id="user-profile-content" class="hidden">
        <!-- User Info Header -->
        <div class="card mb-6">
          <div class="flex items-center gap-4">
            <span id="viewed-user-flag" class="text-6xl"></span>
            <div class="flex-1">
              <div class="flex items-center gap-3">
                <h1 id="viewed-user-username" class="text-3xl font-bold"></h1>
                <span id="viewed-user-gender" class="text-2xl"></span>
              </div>
              <p id="viewed-user-team" style="color: var(--text-secondary)" class="text-lg"></p>
              <div class="flex items-center gap-4 mt-3">
                <span id="viewed-user-dots" class="btn btn-primary btn-sm"></span>
                <span id="viewed-user-total" style="color: var(--text-secondary)"></span>
                <span id="viewed-user-bodyweight" style="color: var(--text-secondary)"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- PR Records -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="card text-center">
            <div class="text-4xl mb-3">üèãÔ∏è</div>
            <div style="color: var(--text-secondary)" class="mb-2">Bench Press</div>
            <div id="viewed-user-bench" class="text-3xl font-bold" style="color: var(--primary-color)"></div>
          </div>
          <div class="card text-center">
            <div class="text-4xl mb-3">ü¶µ</div>
            <div style="color: var(--text-secondary)" class="mb-2">Squat</div>
            <div id="viewed-user-squat" class="text-3xl font-bold" style="color: var(--primary-color)"></div>
          </div>
          <div class="card text-center">
            <div class="text-4xl mb-3">üèãÔ∏è‚Äç‚ôÇÔ∏è</div>
            <div style="color: var(--text-secondary)" class="mb-2">Deadlift</div>
            <div id="viewed-user-deadlift" class="text-3xl font-bold" style="color: var(--primary-color)"></div>
          </div>
        </div>

        <!-- Videos Section -->
        <div class="mb-8">
          <h2 class="text-2xl font-bold mb-6">üìπ PR Videos</h2>
          <div id="viewed-user-videos" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <!-- Videos will be loaded here -->
          </div>
        </div>

        <!-- PR History -->
        <div>
          <h2 class="text-2xl font-bold mb-6">üìà PR History</h2>
          <div class="card">
            <div id="viewed-user-history" class="space-y-4">
              <!-- PR history will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (['localhost','127.0.0.1'].includes(window.location.hostname) ? '' : 'https://gymbakugan.onrender.com');

    // Data caching system
    const dataCache = {
      leaderboard: { data: null, timestamp: 0, ttl: 60000 }, // 1 minute
      teamLeaderboard: { data: null, timestamp: 0, ttl: 60000 }, // 1 minute
      videos: { data: null, timestamp: 0, ttl: 30000 }, // 30 seconds
      userProfiles: new Map(), // username -> { data, timestamp, ttl: 300000 } // 5 minutes
    };

    // Navigation history for back button
    let navigationHistory = [];
    let currentSection = 'home'; // Track current section explicitly
    let lastSectionBeforeProfile = null; // Track the section we came from when viewing a profile

    function isCacheValid(cacheEntry) {
      return cacheEntry.data && (Date.now() - cacheEntry.timestamp) < cacheEntry.ttl;
    }

    function setCacheData(key, data, ttl = 60000) {
      if (key === 'userProfiles') return; // Handle separately
      dataCache[key] = { data, timestamp: Date.now(), ttl };
    }

    function setCacheUserProfile(username, data) {
      dataCache.userProfiles.set(username, { 
        data, 
        timestamp: Date.now(), 
        ttl: 300000 // 5 minutes for user profiles
      });
    }

    // Navigation functionality
    function showSection(sectionName, updateURL = true, addToHistory = true) {
      console.log(`showSection: ${sectionName}, currentSection: ${currentSection}, addToHistory: ${addToHistory}`);
      
      // Add current section to history if not user-profile and section is changing
      if (addToHistory && sectionName !== 'user-profile' && currentSection !== sectionName) {
        console.log(`Adding ${currentSection} to navigationHistory`);
        navigationHistory.push(currentSection);
        // Keep history reasonable size
        if (navigationHistory.length > 5) {
          navigationHistory.shift();
        }
      }
      
      // Update current section tracker
      if (sectionName !== 'user-profile') {
        currentSection = sectionName;
        console.log(`Updated currentSection to: ${currentSection}`);
      }

      // Hide all sections with fade out
      document.querySelectorAll('.section').forEach(section => {
        if (!section.classList.contains('hidden')) {
          section.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
          section.style.opacity = '0';
          section.style.transform = 'translateY(10px)';
          setTimeout(() => {
            section.classList.add('hidden');
          }, 200);
        }
      });
      
      // Remove active state from all nav buttons
      document.querySelectorAll('.nav-link').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected section with fade in after delay
      setTimeout(() => {
        const targetSection = document.getElementById(`${sectionName}-section`);
        targetSection.classList.remove('hidden');
        targetSection.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        targetSection.style.opacity = '0';
        targetSection.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
          targetSection.style.opacity = '1';
          targetSection.style.transform = 'translateY(0)';
        }, 50);
      }, 200);
      
      // Add active state to clicked nav button (if it exists)
      const activeBtn = document.getElementById(`nav-${sectionName}`);
      if (activeBtn) {
        activeBtn.classList.add('active');
      }
      
      // Update URL without page reload
      if (updateURL && history.pushState && sectionName !== 'user-profile') {
        const url = sectionName === 'home' ? '/' : `/#${sectionName}`;
        history.pushState({section: sectionName}, '', url);
      }
      
      // Load data for specific sections with delay for smooth transition
      setTimeout(() => {
        if (sectionName === 'videos') {
          loadVideosCached();
        } else if (sectionName === 'leaderboard') {
          loadLeaderboardCached();
        } else if (sectionName === 'teams') {
          loadTeamsCached();
        } else if (sectionName === 'team-detail') {
          // Team detail loading is handled by showTeamDetailPage
        } else if (sectionName === 'profile') {
          loadUserProfile();
        } else if (sectionName === 'home') {
          loadLeaderboardCached(); // For stats
        }
      }, 250);
    }

    // Back navigation function
    function goBackToPrevious() {
      console.log('goBackToPrevious called');
      console.log('lastSectionBeforeProfile:', lastSectionBeforeProfile);
      console.log('navigationHistory:', navigationHistory);
      
      // If we have a saved section before profile, go back to that
      if (lastSectionBeforeProfile) {
        console.log('Going back to lastSectionBeforeProfile:', lastSectionBeforeProfile);
        const targetSection = lastSectionBeforeProfile;
        lastSectionBeforeProfile = null; // Clear it after using
        showSection(targetSection, true, false);
      } else if (navigationHistory.length > 0) {
        const previousSection = navigationHistory.pop();
        console.log('Going back to history section:', previousSection);
        showSection(previousSection, true, false);
      } else {
        console.log('No history, going to home');
        showSection('home', true, false);
      }
    }

    // Function to show user profile
    function showUserProfile(username) {
      console.log('showUserProfile called from section:', currentSection);
      lastSectionBeforeProfile = currentSection; // Remember where we came from
      console.log('Saved lastSectionBeforeProfile as:', lastSectionBeforeProfile);
      
      // Update breadcrumb information
      const breadcrumbSection = document.getElementById('breadcrumb-section');
      const breadcrumbUsername = document.getElementById('breadcrumb-username');
      const backButtonText = document.getElementById('back-button-text');
      
      const sectionNames = {
        'home': 'üè† Home',
        'leaderboard': 'üèÜ Leaderboard', 
        'teams': 'üèüÔ∏è Teams',
        'videos': 'üìπ Videos',
        'profile': 'üë§ Profile'
      };
      
      if (breadcrumbSection && breadcrumbUsername && backButtonText) {
        const sectionName = sectionNames[currentSection] || 'Previous';
        breadcrumbSection.textContent = sectionName;
        breadcrumbSection.onclick = () => goBackToPrevious();
        breadcrumbUsername.textContent = `@${username}`;
        backButtonText.textContent = sectionName.replace(/üè†|üèÜ|üèüÔ∏è|üìπ|üë§/g, '').trim();
      }
      
      showSection('user-profile', false, false); // Don't use history system for profile
      loadUserProfileCached(username);
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', (event) => {
      const section = event.state?.section || getHashSection() || 'home';
      currentSection = section; // Update current section for browser navigation
      showSection(section, false, false); // Don't add to history for browser navigation
    });

    // Get section from URL hash
    function getHashSection() {
      const hash = window.location.hash.replace('#', '');
      const validSections = ['home', 'videos', 'leaderboard', 'teams', 'profile'];
      return validSections.includes(hash) ? hash : null;
    }

    // Handle special hash actions
    function handleSpecialHashes() {
      const hash = window.location.hash.replace('#', '');
      if (hash === 'login-modal') {
        // Clear the hash and show login modal
        history.replaceState(null, '', window.location.pathname);
        setTimeout(() => showLoginModal(), 100);
      } else if (hash === 'register-modal') {
        // Clear the hash and show register modal
        history.replaceState(null, '', window.location.pathname);
        setTimeout(() => showRegisterModal(), 100);
      } else if (hash.startsWith('user-profile-')) {
        // Extract username and show user profile
        const username = hash.replace('user-profile-', '');
        history.replaceState(null, '', window.location.pathname);
        setTimeout(() => showUserProfile(username), 100);
      }
    }

    // Login Modal
    function showLoginModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content card" style="max-width: 420px; padding: 0;">
          <!-- Modal Header -->
          <div class="p-6 border-b" style="border-color: var(--border); background: linear-gradient(135deg, var(--background-alt) 0%, var(--background) 100%);">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-2xl font-bold">Welcome Back</h3>
                <p class="text-sm" style="color: var(--text-secondary)">Sign in to your GymRank account</p>
              </div>
              <button onclick="this.closest('.modal').remove()" class="btn btn-outline btn-sm">‚úï</button>
            </div>
          </div>

          <!-- Modal Body -->
          <div class="p-6">
            <form id="modal-login-form">
              <div class="form-group mb-4">
                <label class="form-label">Username</label>
                <input 
                  type="text" 
                  id="modal-username" 
                  class="form-input w-full" 
                  placeholder="Enter your username" 
                  required
                >
              </div>
              
              <div class="form-group mb-6">
                <label class="form-label">Password</label>
                <div class="relative">
                  <input 
                    type="password" 
                    id="modal-password" 
                    class="form-input pr-10 w-full" 
                    placeholder="Enter your password" 
                    required
                  >
                  <button 
                    type="button" 
                    class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer toggle-password"
                    style="background: none; border: none; color: var(--text-secondary); top: 50%; transform: translateY(-50%);"
                  >
                    <span class="text-lg">üëÅÔ∏è</span>
                  </button>
                </div>
              </div>

              <button type="submit" class="btn btn-primary w-full btn-lg mb-4 flex items-center justify-center">
                <span class="mr-2">üîë</span>
                <span class="sign-in-text">Sign In</span>
                <span class="loading-spinner hidden ml-2">
                  <div class="dot-matrix-spinner small">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                  </div>
                </span>
              </button>
            </form>

            <div class="text-center">
              <p class="text-sm mb-2" style="color: var(--text-secondary)">
                <a href="forgot-password.html" class="hover:underline" style="color: var(--primary-color)">
                  Forgot your password?
                </a>
              </p>
              <p class="text-sm" style="color: var(--text-secondary)">
                Don't have an account? 
                <button onclick="this.closest('.modal').remove(); showRegisterModal();" class="hover:underline" style="color: var(--primary-color); background: none; border: none; cursor: pointer;">
                  Sign up here
                </button>
              </p>
            </div>
          </div>
        </div>
      `;

      // Add click outside to close
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Password visibility toggle
      const togglePassword = modal.querySelector('.toggle-password');
      const passwordInput = modal.querySelector('#modal-password');
      togglePassword.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePassword.innerHTML = type === 'password' ? '<span class="text-lg">üëÅÔ∏è</span>' : '<span class="text-lg">üôà</span>';
      });

      // Handle form submission
      modal.querySelector('#modal-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = modal.querySelector('#modal-username').value;
        const password = modal.querySelector('#modal-password').value;
        const submitBtn = modal.querySelector('button[type="submit"]');
        const signInText = submitBtn.querySelector('.sign-in-text');
        const loadingSpinner = submitBtn.querySelector('.loading-spinner');
        
        // Validate inputs
        if (!username || !password) {
          showAlert('Please fill in all fields', 'error');
          return;
        }

        // Show loading state
        signInText.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
        submitBtn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          const data = await response.json();

          if (data.error) {
            showAlert('Login failed: ' + data.error, 'error');
          } else {
            localStorage.setItem('gymrank_user', JSON.stringify(data));
            modal.remove();
            checkUserSession(); // Refresh UI
            showSection('home');
          }
        } catch (error) {
          showAlert('Login failed. Please check your connection.', 'error');
        } finally {
          signInText.classList.remove('hidden');
          loadingSpinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });
      
      document.body.appendChild(modal);
      modal.querySelector('#modal-username').focus();
    }

    // Enhanced alert function
    function showAlert(message, type = 'info') {
      // Remove existing alerts
      const existingAlert = document.querySelector('.alert');
      if (existingAlert) {
        existingAlert.remove();
      }

      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} fixed top-4 right-4 z-50 max-w-sm`;
      alertDiv.style.zIndex = '9999';
      
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
      alertDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <span>${icon}</span>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(alertDiv);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Register Modal
    function showRegisterModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content card" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="text-3xl">üèãÔ∏è</div>
              <h3 class="text-2xl font-bold">Join GymRank</h3>
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn btn-outline btn-sm">‚úï</button>
          </div>

          <form id="modal-register-form" class="space-y-4">
            <div class="form-group">
              <label class="form-label">Username</label>
              <input type="text" id="modal-reg-username" class="form-input" placeholder="Choose a username" required>
            </div>
            
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" id="modal-reg-password" class="form-input" placeholder="Create a password" required>
              <p class="text-sm mt-1" style="color: var(--text-secondary)">Must be at least 6 characters</p>
            </div>

            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="modal-reg-email" class="form-input" placeholder="your@email.com" required>
            </div>

            <div class="form-group">
              <label class="form-label">Display Name (Optional)</label>
              <input type="text" id="modal-reg-display-name" class="form-input" placeholder="How you want to be displayed">
            </div>

            <div class="form-group">
              <label class="form-label">Team/Gym</label>
              <input type="text" id="modal-reg-team" class="form-input" placeholder="Enter your team/gym name">
            </div>

            <div class="form-group">
              <label class="form-label">Country/Region</label>
              <select id="modal-reg-flag" class="form-input" required>
                <option value="">Select your country</option>
                <option value="üá∫üá∏">üá∫üá∏ United States</option>
                <option value="üá®üá¶">üá®üá¶ Canada</option>
                <option value="üá¨üáß">üá¨üáß United Kingdom</option>
                <option value="üá¶üá∫">üá¶üá∫ Australia</option>
                <option value="üá©üá™">üá©üá™ Germany</option>
                <option value="üá´üá∑">üá´üá∑ France</option>
                <option value="üáÆüáπ">üáÆüáπ Italy</option>
                <option value="üá™üá∏">üá™üá∏ Spain</option>
                <option value="üáØüáµ">üáØüáµ Japan</option>
                <option value="üá∏üá¨">üá∏üá¨ Singapore</option>
                <option value="üåç">üåç Other</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Gender</label>
              <select id="modal-reg-gender" class="form-input" required>
                <option value="">Select gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-full btn-lg">
              <span class="mr-2">üöÄ</span>
              Create Account
            </button>
          </form>

          <div class="text-center mt-4">
            <p class="text-sm" style="color: var(--text-secondary)">
              Already have an account? 
              <button onclick="this.closest('.modal').remove(); showLoginModal();" class="hover:underline" style="color: var(--primary-color); background: none; border: none; cursor: pointer;">
                Sign in here
              </button>
            </p>
          </div>
        </div>
      `;

      // Add click outside to close
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Handle form submission
      modal.querySelector('#modal-register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
          username: modal.querySelector('#modal-reg-username').value,
          password: modal.querySelector('#modal-reg-password').value,
          email: modal.querySelector('#modal-reg-email').value,
          display_name: modal.querySelector('#modal-reg-display-name').value,
          team: modal.querySelector('#modal-reg-team').value || 'Independent',
          flag: modal.querySelector('#modal-reg-flag').value,
          gender: modal.querySelector('#modal-reg-gender').value
        };

        const submitBtn = modal.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="mr-2">‚è≥</span>Creating account...';
        submitBtn.disabled = true;

        try {
          const response = await fetch(`${API_BASE}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          const data = await response.json();

          if (data.error) {
            alert('Registration failed: ' + data.error);
          } else {
            alert('Registration successful! Please login.');
            modal.remove();
            showLoginModal();
          }
        } catch (error) {
          alert('Registration failed. Please check your connection.');
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });
      
      document.body.appendChild(modal);
      modal.querySelector('#modal-reg-username').focus();
    }

    // Theme management
    function toggleTheme() {
      const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      if (newTheme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      localStorage.setItem('gymrank-theme', newTheme);
      
      // Update theme icon
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function initializeTheme() {
      const savedTheme = localStorage.getItem('gymrank-theme') || 'light';
      
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      
      // Update theme icon
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // User session management
    let currentUser = null;
    let currentGenderFilter = '';
    let currentCountryFilter = '';

    // Check for saved user session on page load
    function checkUserSession() {
      const savedUser = localStorage.getItem('gymrank_user');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          updateUIForLoggedInUser();
        } catch (e) {
          localStorage.removeItem('gymrank_user');
        }
      }
    }

    // Auto-fill username when logged in
    function updateUIForLoggedInUser() {
      if (currentUser) {
        // Show user info, logout button, hide auth buttons
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('logged-in-user').innerHTML = `
          <span>${currentUser.flag}</span>
          <div class="text-left">
            <div class="font-medium">${currentUser.display_name || currentUser.username}</div>
            <div class="text-xs" style="color: var(--text-secondary)">${currentUser.team || 'Independent'}</div>
          </div>
        `;
        document.getElementById('auth-buttons').classList.add('hidden');
        
        // Show PR section, hide welcome section
        document.getElementById('pr-section').classList.remove('hidden');
        document.getElementById('welcome-section').classList.add('hidden');
        
      } else {
        // Show auth buttons, hide user info, logout button
        document.getElementById('user-info').classList.add('hidden');
        document.getElementById('logout-btn').classList.add('hidden');
        document.getElementById('auth-buttons').classList.remove('hidden');
        
        // Hide PR section, show welcome section
        document.getElementById('pr-section').classList.add('hidden');
        document.getElementById('welcome-section').classList.remove('hidden');
      }
    }

    // Logout function
    function logout() {
      currentUser = null;
      localStorage.removeItem('gymrank_user');
      
      // Update UI
      updateUIForLoggedInUser();
      
      alert('Logged out successfully!');
    }

    // Switch to mobile version
    function switchToMobile() {
      DeviceDetection.forceMobileVersion();
    }

    // Load leaderboard
    // Cached loading functions
    function loadLeaderboardCached(gender = '', country = '') {
      const cacheKey = `leaderboard_${gender}_${country}`;
      const cached = dataCache.leaderboard;
      
      if (isCacheValid(cached) && !gender && !country) {
        displayLeaderboard(cached.data);
        return;
      }
      
      loadLeaderboard(gender, country);
    }

    function loadVideosCached() {
      const cached = dataCache.videos;
      
      if (isCacheValid(cached)) {
        displayVideos(cached.data);
        return;
      }
      
      loadVideos();
    }

    function loadTeamsCached() {
      const cached = dataCache.teamLeaderboard;
      
      if (isCacheValid(cached)) {
        displayTeams(cached.data);
        return;
      }
      
      loadTeams();
    }

    function loadUserProfileCached(username) {
      const cached = dataCache.userProfiles.get(username);
      
      if (cached && isCacheValid(cached)) {
        displayUserProfileView(cached.data);
        return;
      }
      
      // Show loading state
      document.getElementById('user-profile-loading').classList.remove('hidden');
      document.getElementById('user-profile-error').classList.add('hidden');
      document.getElementById('user-profile-content').classList.add('hidden');
      
      fetch(`${API_BASE}/api/user/${username}`)
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            showUserProfileError();
            return;
          }
          
          setCacheUserProfile(username, data);
          displayUserProfileView(data);
        })
        .catch(err => {
          console.error('Error loading user profile:', err);
          showUserProfileError();
        });
    }

    function showUserProfileError() {
      document.getElementById('user-profile-loading').classList.add('hidden');
      document.getElementById('user-profile-error').classList.remove('hidden');
      document.getElementById('user-profile-content').classList.add('hidden');
    }

    function displayUserProfileView(data) {
      const user = data.user;
      const prs = data.current_prs;
      const genderEmoji = user.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
      
      // Populate user info
      document.getElementById('viewed-user-flag').textContent = user.flag;
      document.getElementById('viewed-user-username').textContent = user.username;
      document.getElementById('viewed-user-gender').textContent = genderEmoji;
      document.getElementById('viewed-user-team').textContent = user.team || 'Independent';
      document.getElementById('viewed-user-dots').textContent = data.dots_score ? `${data.dots_score} DOTS` : 'N/A';
      document.getElementById('viewed-user-total').textContent = `${data.total_lifted}kg Total`;
      document.getElementById('viewed-user-bodyweight').textContent = user.weight ? `${user.weight}kg BW` : 'N/A';
      
      // Populate PR records
      document.getElementById('viewed-user-bench').textContent = prs.bench ? `${prs.bench}kg` : 'N/A';
      document.getElementById('viewed-user-squat').textContent = prs.squat ? `${prs.squat}kg` : 'N/A';
      document.getElementById('viewed-user-deadlift').textContent = prs.deadlift ? `${prs.deadlift}kg` : 'N/A';
      
      // Populate videos
      const videosContainer = document.getElementById('viewed-user-videos');
      if (data.videos.length === 0) {
        videosContainer.innerHTML = '<p style="color: var(--text-secondary)" class="text-center py-8 col-span-full">No videos available</p>';
      } else {
        videosContainer.innerHTML = data.videos.map(video => {
          const liftEmoji = video.lift_type === 'bench' ? 'üèãÔ∏è' : video.lift_type === 'squat' ? 'ü¶µ' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
          return `
            <div class="card card-compact transition-shadow hover:shadow-lg">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <span class="text-2xl">${liftEmoji}</span>
                  <div>
                    <div class="font-semibold text-lg">${video.weight}kg</div>
                    <div class="text-sm capitalize" style="color: var(--text-secondary)">${video.lift_type}</div>
                  </div>
                </div>
                <a href="${video.video_url}" target="_blank" rel="noopener noreferrer" 
                   class="btn btn-outline btn-sm">
                  Watch ‚Üí
                </a>
              </div>
              <div class="text-xs" style="color: var(--text-secondary)">
                ${new Date(video.created_at).toLocaleDateString()}
              </div>
            </div>
          `;
        }).join('');
      }
      
      // Populate PR history
      const historyContainer = document.getElementById('viewed-user-history');
      if (data.history.length === 0) {
        historyContainer.innerHTML = '<p style="color: var(--text-secondary)" class="text-center py-8">No PR history available</p>';
      } else {
        historyContainer.innerHTML = data.history.map(record => {
          const liftEmoji = record.lift_type === 'bench' ? 'üèãÔ∏è' : record.lift_type === 'squat' ? 'ü¶µ' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
          return `
            <div class="flex items-center justify-between p-4 border" style="border-color: var(--border); border-radius: 0.5rem;" class="hover:bg-muted transition-colors">
              <div class="flex items-center gap-4">
                <span class="text-2xl">${liftEmoji}</span>
                <div>
                  <div class="font-semibold text-lg">${record.weight}kg ${record.lift_type}</div>
                  <div class="text-sm" style="color: var(--text-secondary)">${new Date(record.created_at).toLocaleDateString()}</div>
                </div>
              </div>
              ${record.video_url ? `
                <a href="${record.video_url}" target="_blank" rel="noopener noreferrer" 
                   class="btn btn-outline btn-sm">
                  Video ‚Üí
                </a>
              ` : ''}
            </div>
          `;
        }).join('');
      }
      
      // Show profile content
      document.getElementById('user-profile-loading').classList.add('hidden');
      document.getElementById('user-profile-error').classList.add('hidden');
      document.getElementById('user-profile-content').classList.remove('hidden');
    }

    // Skeleton renderers (desktop)
    function renderLeaderboardSkeleton(n = 8) {
      return Array.from({ length: n }).map(() => `
        <div class=\"skel-row\">
          <div class=\"skel-left\">
            <div class=\"skel-rank skeleton\"></div>
            <div class=\"skel-flag skeleton\"></div>
            <div>
              <div class=\"skel-line skeleton\" style=\"width: 140px;\"></div>
              <div class=\"skel-sub skeleton\" style=\"width: 120px;\"></div>
            </div>
          </div>
          <div style=\"text-align:right;\">
            <div class=\"skel-badge skeleton\" style=\"width: 100px;\"></div>
            <div class=\"skel-sub skeleton\" style=\"width: 80px;\"></div>
          </div>
        </div>
      `).join('');
    }

    function renderVideoSkeleton(n = 6) {
      return Array.from({ length: n }).map(() => `
        <div class=\"card\" style=\"min-height: 320px; padding: 1.5rem;\">
          <div class=\"skeleton\" style=\"width: 60%; height: 14px; border-radius: 8px; margin-bottom: 10px;\"></div>
          <div class=\"skeleton\" style=\"width: 40%; height: 12px; border-radius: 8px; margin-bottom: 16px;\"></div>
          <div class=\"skeleton\" style=\"width: 100%; height: 140px; border-radius: 10px; margin-bottom: 16px;\"></div>
          <div style=\"display:flex; justify-content: space-between; align-items: center;\">
            <div class=\"skeleton\" style=\"width: 140px; height: 20px; border-radius: 8px;\"></div>
            <div class=\"skeleton\" style=\"width: 80px; height: 32px; border-radius: 8px;\"></div>
          </div>
        </div>
      `).join('');
    }

    function renderTeamsSkeleton(n = 8) {
      return Array.from({ length: n }).map(() => `
        <div class=\"skel-row\">
          <div class=\"skel-left\">
            <div class=\"skel-rank skeleton\"></div>
            <div>
              <div class=\"skel-line skeleton\" style=\"width: 160px;\"></div>
              <div class=\"skel-sub skeleton\" style=\"width: 100px;\"></div>
            </div>
          </div>
          <div style=\"text-align:right;\">
            <div class=\"skel-badge skeleton\" style=\"width: 110px;\"></div>
            <div class=\"skel-sub skeleton\" style=\"width: 80px;\"></div>
          </div>
        </div>
      `).join('');
    }

    // Original loading functions (updated to cache data)
    function loadLeaderboard(gender = '', country = '') {
      const params = new URLSearchParams();
      if (gender) params.append('gender', gender);
      if (country) params.append('country', country);
      const url = `${API_BASE}/api/leaderboard${params.toString() ? '?' + params.toString() : ''}`;
      // show skeleton
      document.getElementById('leaderboard').innerHTML = renderLeaderboardSkeleton(8);
      
      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (!gender && !country) {
            setCacheData('leaderboard', data);
          }
          displayLeaderboard(data);
        })
        .catch(err => {
          document.getElementById('leaderboard').innerHTML = 
            '<div class="text-center py-8" style="color: var(--error)">Error loading leaderboard.</div>';
        });
    }

    function displayLeaderboard(data) {
      const list = document.getElementById('leaderboard');
      if (data.length === 0) {
        list.innerHTML = '<p class="text-center py-8" style="color: var(--text-secondary)">No qualified lifters yet. Complete all three lifts (bench, squat, deadlift) with bodyweight recorded!</p>';
        return;
      }
      
      list.innerHTML = data.map((user, index) => {
            const rank = index + 1;
            const genderEmoji = user.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
            
            const rankTitle = rank === 1 ? 'üëë Champion' : rank === 2 ? 'ü•à Elite' : rank === 3 ? 'ü•â Titan' : 'üèÖ Brawler';
            const rankColor = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : 'var(--primary-color)';
            
            return `
              <div onclick="showUserProfile('${user.username}')" 
                   class="card flex items-center justify-between cursor-pointer transition-colors leaderboard-item"
                   role="button" 
                   tabindex="0"
                   aria-label="View ${user.username}'s profile - Rank ${rank} with ${user.dots_score} DOTS"
                   onkeydown="if(event.key==='Enter'||event.key===' ') showUserProfile('${user.username}')">
                <div class="flex items-center gap-4">
                  <span class="rank-number text-2xl font-bold" style="color: ${rankColor}">#${rank}</span>
                  <span class="text-2xl" role="img" aria-label="${user.flag} flag">${user.flag}</span>
                  <div class="flex flex-col">
                    <div class="flex items-center gap-1">
                      <span class="font-semibold">${user.username}</span>
                      <span class="text-lg" role="img" aria-label="${user.gender === 'male' ? 'Male' : 'Female'}">${genderEmoji}</span>
                    </div>
                    <span class="text-sm" style="color: var(--text-secondary)">${user.team || 'Independent'}</span>
                    <span class="text-xs" style="color: var(--text-secondary)">
                      B: ${user.bench}kg | S: ${user.squat}kg | D: ${user.deadlift}kg | BW: ${user.weight}kg
                    </span>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold" style="color: var(--primary-color)">${user.dots_score} DOTS</div>
                  <div class="text-sm font-medium">${user.total_lifted}kg Total</div>
                  <div class="text-sm font-medium" style="color: ${rankColor}">
                    ${rankTitle}
                  </div>
                  <div class="text-xs mt-1" style="color: var(--text-secondary)">
                    Click to view profile ‚Üí
                  </div>
                </div>
              </div>
            `;
          }).join('');
          
          // Update stats
          document.getElementById('total-users').textContent = data.length || '0';
          document.getElementById('top-elo').textContent = data[0] ? data[0].dots_score : '0';
          
          // Calculate total PRs from all users
          const totalPRs = data.reduce((sum, user) => {
            const userPRs = (user.bench > 0 ? 1 : 0) + (user.squat > 0 ? 1 : 0) + (user.deadlift > 0 ? 1 : 0);
            return sum + userPRs;
          }, 0);
          document.getElementById('total-prs').textContent = totalPRs || '0';
    }

    // Set active filter button
    function setActiveFilter(filter) {
      // Update current gender filter
      currentGenderFilter = filter === 'all' ? '' : filter;
      
      // Remove active styles from all filter buttons
      document.querySelectorAll('#filter-all, #filter-male, #filter-female').forEach(btn => {
        btn.className = 'btn btn-outline';
      });
      
      // Add active styles to selected button
      const activeBtn = document.getElementById(`filter-${filter}`);
      if (activeBtn) {
        activeBtn.className = 'btn btn-primary';
      }
    }

    // Filter leaderboard by country
    function filterByCountry(country) {
      currentCountryFilter = country;
      loadLeaderboard(currentGenderFilter, currentCountryFilter);
    }

    // Load videos
    function loadVideos() {
      // show skeleton
      document.getElementById('videos-grid').innerHTML = renderVideoSkeleton(6);
      fetch(`${API_BASE}/api/videos`)
        .then(res => res.json())
        .then(data => {
          setCacheData('videos', data);
          displayVideos(data);
        })
        .catch(err => {
          document.getElementById('videos-grid').innerHTML = 
            '<div class="text-center py-8 col-span-full" style="color: var(--error)">Error loading videos.</div>';
        });
    }

    function displayVideos(data) {
          const grid = document.getElementById('videos-grid');
          if (data.length === 0) {
            grid.innerHTML = '<p class="text-center py-8 col-span-full" style="color: var(--text-secondary)">No videos yet. Upload the first one!</p>';
            return;
          }
          
          grid.innerHTML = data.map(video => {
            const liftEmoji = {
              'bench': 'üèãÔ∏è',
              'deadlift': 'üèãÔ∏è‚Äç‚ôÇÔ∏è',
              'squat': 'ü¶µ'
            };
            
            // Extract Instagram post ID for embedding
            const instagramId = extractInstagramId(video.video_url);
            const canEmbed = instagramId !== null;
            
            return `
              <div class="card hover:shadow-lg transition-shadow video-card" style="min-height: 320px; padding: 1.5rem;">
                <div class="mb-4">
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-3">
                      <span class="text-xl" role="img" aria-label="${video.flag} flag">${video.flag}</span>
                      <button onclick="showUserProfile('${video.username}')" 
                              class="text-base font-bold hover:underline cursor-pointer" 
                              style="color: var(--primary-color); background: none; border: none; padding: 0; font-family: inherit;"
                              aria-label="View ${video.username}'s profile">${video.username}</button>
                    </div>
                    <div class="text-right">
                      <div class="text-xs mb-1" style="color: var(--text-secondary)">
                        ${new Date(video.created_at).toLocaleDateString()}
                      </div>
                      <span class="text-xs px-3 py-1 rounded" style="background-color: var(--primary-color); color: white">
                        ${video.dots_score ? video.dots_score + ' DOTS' : video.elo.toFixed(0) + ' ELO'}
                      </span>
                    </div>
                  </div>
                  <div class="text-sm" style="color: var(--text-secondary)">${video.team || 'Independent'}</div>
                </div>

                <!-- Video Preview/Embed Section -->
                <div class="mb-4 bg-gray-100 rounded-lg overflow-hidden" style="background: var(--background-alt); min-height: 380px;">
                  ${canEmbed ? `
                    <div class="relative">
                      <div class="instagram-embed-placeholder" 
                           style="min-height: 360px; display: flex; align-items: center; justify-content: center; cursor: pointer;"
                           onclick="loadInstagramEmbed(this, '${video.video_url}')">
                        <div class="text-center">
                          <div class="text-4xl mb-2">üì±</div>
                          <div class="text-sm font-medium">Click to load Instagram video</div>
                          <div class="text-xs" style="color: var(--text-secondary)">Tap to view embedded content</div>
                        </div>
                      </div>
                    </div>
                  ` : `
                    <div class="flex items-center justify-center h-full py-8">
                      <div class="text-center">
                        <div class="text-4xl mb-2">üé•</div>
                        <div class="text-sm" style="color: var(--text-secondary)">Video preview not available</div>
                      </div>
                    </div>
                  `}
                </div>
                
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <span class="text-3xl" role="img" aria-label="${video.lift_type}">${liftEmoji[video.lift_type] || 'üèãÔ∏è'}</span>
                    <div>
                      <div class="font-bold text-xl" style="color: var(--primary-color)">${video.weight}kg</div>
                      <div class="text-sm capitalize font-medium" style="color: var(--text-secondary)">${video.lift_type}</div>
                    </div>
                  </div>
                  
                  <div class="flex items-center gap-2">
                    <!-- Social sharing buttons -->
                    <button onclick="shareVideo('${video.username}', '${video.lift_type}', '${video.weight}', '${video.video_url}')" 
                            class="btn btn-ghost btn-sm tooltip" 
                            aria-label="Share this PR"
                            title="Share this PR">
                      <span>üîó</span>
                      <span class="tooltiptext">Share</span>
                    </button>
                    
                    <!-- Like button (placeholder for future functionality) -->
                    <button class="btn btn-ghost btn-sm tooltip" 
                            aria-label="Like this PR"
                            title="Like this PR">
                      <span>‚ù§Ô∏è</span>
                      <span class="tooltiptext">Like</span>
                    </button>
                    
                    <!-- View on Instagram button -->
                    <a href="${video.video_url}" target="_blank" rel="noopener noreferrer" 
                       class="btn btn-primary btn-sm tooltip"
                       aria-label="View on Instagram">
                      <span class="text-sm">üì±</span>
                      <span class="ml-1">Instagram</span>
                      <span class="tooltiptext">View on Instagram</span>
                    </a>
                  </div>
                </div>
              </div>
            `;
          }).join('');
    }

    // Extract Instagram post ID from URL
    function extractInstagramId(url) {
      try {
        const patterns = [
          /instagram\.com\/p\/([A-Za-z0-9_-]+)/,
          /instagram\.com\/reel\/([A-Za-z0-9_-]+)/,
          /instagram\.com\/tv\/([A-Za-z0-9_-]+)/
        ];
        
        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match) {
            return match[1];
          }
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Parse Instagram URL into type and id (supports p/reel/tv)
    function parseInstagramInfo(url) {
      try {
        const match = url.match(/instagram\.com\/(p|reel|tv)\/([A-Za-z0-9_-]+)/);
        if (match) {
          return { type: match[1], id: match[2] };
        }
        return null;
      } catch (e) {
        return null;
      }
    }

    // Load Instagram embed (lazy loading, responsive and larger)
    function loadInstagramEmbed(element, instagramUrl) {
      if (!instagramUrl) return;
      const info = parseInstagramInfo(instagramUrl);
      if (!info) {
        element.innerHTML = '<div class="text-center py-8" style="color: var(--text-secondary)">Unable to load Instagram embed</div>';
        return;
      }
      
      // Show loading state
      element.innerHTML = `
        <div class="flex items-center justify-center py-8">
          <div class="dot-matrix-spinner">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
          </div>
        </div>
      `;
      
      // Create Instagram embed with responsive 9:16 aspect ratio
      const embedUrl = `https://www.instagram.com/${info.type}/${info.id}/embed/`;
      
      element.innerHTML = `
        <div class="ig-embed-wrapper" style="position: relative; width: 100%; aspect-ratio: 9 / 16; max-height: 720px; background: #000;">
          <iframe 
            src="${embedUrl}"
            frameborder="0"
            scrolling="no"
            allowtransparency="true"
            allowfullscreen="true"
            onload="this.style.opacity=1"
            onerror="this.parentElement.innerHTML='<div class=\\'text-center py-8\\' style=\\'color: var(--text-secondary)\\'>Unable to load Instagram embed</div>'"
            style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0; border-radius: 12px; opacity: 0; transition: opacity 0.3s ease;"
          ></iframe>
        </div>
      `;
    }

    // Share video functionality
    function shareVideo(username, liftType, weight, videoUrl) {
      const shareText = `Check out ${username}'s ${weight}kg ${liftType} PR on GymRank! üèãÔ∏è`;
      const shareUrl = window.location.origin + `#user-profile-${username}`;
      
      if (navigator.share) {
        // Use native sharing if available
        navigator.share({
          title: 'GymRank PR',
          text: shareText,
          url: shareUrl
        }).catch(err => {
          console.log('Error sharing:', err);
          fallbackShare(shareText, shareUrl);
        });
      } else {
        fallbackShare(shareText, shareUrl);
      }
    }

    // Fallback sharing method
    function fallbackShare(text, url) {
      // Copy to clipboard
      const shareContent = `${text}\n\n${url}`;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareContent).then(() => {
          showAlert('Share link copied to clipboard! üìã', 'success');
        }).catch(() => {
          showShareModal(text, url);
        });
      } else {
        showShareModal(text, url);
      }
    }

    // Show share modal as final fallback
    function showShareModal(text, url) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content card" style="max-width: 400px;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Share PR</h3>
            <button onclick="this.closest('.modal').remove()" class="btn btn-outline btn-sm">‚úï</button>
          </div>
          <div class="mb-4">
            <label class="form-label">Share this PR:</label>
            <textarea class="form-input" rows="3" readonly onclick="this.select()">${text}\n\n${url}</textarea>
          </div>
          <div class="flex gap-2">
            <button onclick="window.open('https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}', '_blank')" 
                    class="btn btn-outline flex-1">
              üê¶ Twitter
            </button>
            <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}', '_blank')" 
                    class="btn btn-outline flex-1">
              üìò Facebook
            </button>
          </div>
        </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }

    // Load teams
    function loadTeams() {
      // show skeleton
      document.getElementById('team-leaderboard').innerHTML = renderTeamsSkeleton(8);
      fetch(`${API_BASE}/api/team_leaderboard`)
        .then(res => res.json())
        .then(data => {
          setCacheData('teamLeaderboard', data);
          displayTeams(data);
        })
        .catch(err => {
          document.getElementById('team-leaderboard').innerHTML = 
            '<div class="text-center py-8" style="color: var(--error)">Error loading teams.</div>';
        });
    }

    // Store original team data for filtering
    let originalTeamData = [];
    let currentTeamSort = 'avg_elo';

    function displayTeams(data) {
          const list = document.getElementById('team-leaderboard');
          if (data.length === 0) {
            list.innerHTML = '<p class="text-center py-8" style="color: var(--text-secondary)">No teams yet.</p>';
            return;
          }
          
          // Store original data for filtering
          originalTeamData = [...data];
          
          list.innerHTML = data.map((team, index) => {
            const rank = index + 1;
            const rankColor = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : 'var(--primary-color)';
            
            return `
              <div class="card flex items-center justify-between cursor-pointer transition-colors team-leaderboard-item" 
                   onclick="showTeamDetailPage('${team.team}')"
                   role="button" 
                   tabindex="0"
                   aria-label="View ${team.team} team details - ${team.member_count} members"
                   onkeydown="if(event.key==='Enter'||event.key===' ') showTeamDetailPage('${team.team}')">
                <div class="flex items-center gap-4">
                  <span class="text-2xl font-bold" style="color: ${rankColor}">#${rank}</span>
                  <div class="flex items-center gap-3">
                    <span class="text-3xl">üèüÔ∏è</span>
                    <div class="flex flex-col">
                      <span class="font-semibold text-lg">${team.team}</span>
                      <span class="text-sm" style="color: var(--text-secondary)">${team.member_count} ${team.member_count === 1 ? 'member' : 'members'}</span>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-lg font-bold">${team.avg_elo.toFixed(0)} Avg ELO</div>
                  <div class="text-sm font-medium" style="color: var(--success)">
                    Top: ${team.top_elo.toFixed(0)} ELO
                  </div>
                  <div class="text-xs mt-1" style="color: var(--text-secondary)">
                    Click to view details ‚Üí
                  </div>
                </div>
              </div>
            `;
          }).join('');
    }

    // Filter teams based on search input
    function filterTeams() {
      const searchTerm = document.getElementById('team-search').value.toLowerCase();
      if (!originalTeamData.length) return;
      
      const filteredData = originalTeamData.filter(team => 
        team.team.toLowerCase().includes(searchTerm)
      );
      
      // Re-sort filtered data
      sortTeamData(filteredData, currentTeamSort);
      displayTeams(filteredData);
    }

    // Sort teams by selected criteria
    function sortTeams(sortBy) {
      currentTeamSort = sortBy;
      const searchTerm = document.getElementById('team-search').value.toLowerCase();
      
      let dataToSort = originalTeamData;
      if (searchTerm) {
        dataToSort = originalTeamData.filter(team => 
          team.team.toLowerCase().includes(searchTerm)
        );
      }
      
      sortTeamData(dataToSort, sortBy);
      displayTeams(dataToSort);
    }

    // Helper function to sort team data
    function sortTeamData(data, sortBy) {
      data.sort((a, b) => {
        switch (sortBy) {
          case 'member_count':
            return b.member_count - a.member_count;
          case 'top_elo':
            return b.top_elo - a.top_elo;
          case 'total_elo':
            return b.total_elo - a.total_elo;
          case 'avg_elo':
          default:
            return b.avg_elo - a.avg_elo;
        }
      });
    }

    // Show team detail page (new dedicated page)
    function showTeamDetailPage(teamName) {
      console.log('showTeamDetailPage called for:', teamName);
      lastSectionBeforeProfile = currentSection; // Remember where we came from
      
      // Update breadcrumb
      document.getElementById('team-detail-name').textContent = teamName;
      
      showSection('team-detail', false, false);
      loadTeamDetailCached(teamName);
    }

    // Load team detail with caching
    function loadTeamDetailCached(teamName) {
      // Show loading state
      document.getElementById('team-detail-loading').classList.remove('hidden');
      document.getElementById('team-detail-error').classList.add('hidden');
      document.getElementById('team-detail-content').classList.add('hidden');
      
      Promise.all([
        fetch(`${API_BASE}/api/team_members/${encodeURIComponent(teamName)}`).then(res => res.json()),
        fetch(`${API_BASE}/api/team_leaderboard`).then(res => res.json())
      ])
      .then(([membersData, teamsData]) => {
        if (!membersData || membersData.length === 0) {
          showTeamDetailError();
          return;
        }

        // Find team rank
        const teamRank = teamsData.findIndex(team => team.team === teamName) + 1;

        // Calculate team stats
        const totalElo = membersData.reduce((sum, member) => sum + member.elo, 0);
        const avgElo = totalElo / membersData.length;
        const topElo = Math.max(...membersData.map(member => member.elo));
        const memberCount = membersData.length;

        displayTeamDetail({
          name: teamName,
          members: membersData,
          stats: {
            avgElo,
            topElo,
            totalElo,
            memberCount,
            rank: teamRank
          }
        });
      })
      .catch(err => {
        console.error('Error loading team details:', err);
        showTeamDetailError();
      });
    }

    function showTeamDetailError() {
      document.getElementById('team-detail-loading').classList.add('hidden');
      document.getElementById('team-detail-error').classList.remove('hidden');
      document.getElementById('team-detail-content').classList.add('hidden');
    }

    function displayTeamDetail(teamData) {
      const { name, members, stats } = teamData;
      
      // Populate team header
      document.getElementById('team-detail-title').textContent = name;
      document.getElementById('team-detail-member-count').textContent = 
        `${stats.memberCount} ${stats.memberCount === 1 ? 'member' : 'members'}`;
      document.getElementById('team-detail-rank').textContent = 
        stats.rank ? `#${stats.rank}` : 'Unranked';

      // Populate team stats
      document.getElementById('team-detail-avg-elo').textContent = stats.avgElo.toFixed(0);
      document.getElementById('team-detail-top-elo').textContent = stats.topElo.toFixed(0);
      document.getElementById('team-detail-members').textContent = stats.memberCount;
      document.getElementById('team-detail-total-elo').textContent = stats.totalElo.toFixed(0);

      // Populate members list
      const membersList = document.getElementById('team-detail-members-list');
      membersList.innerHTML = members.map((member, index) => {
        const rank = index + 1;
        const rankColor = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : 'var(--text-secondary)';
        const rankIcon = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : 'üèÖ';
        
        return `
          <div class="flex items-center justify-between p-4 rounded-lg border transition-all hover:shadow-md cursor-pointer team-member-item" 
               style="border-color: var(--border); background: var(--background);"
               onclick="showUserProfile('${member.username}')"
               role="button" 
               tabindex="0"
               aria-label="View ${member.username}'s profile - ${member.elo.toFixed(0)} ELO"
               onkeydown="if(event.key==='Enter'||event.key===' ') showUserProfile('${member.username}')">
            <div class="flex items-center gap-4">
              <div class="flex items-center gap-2">
                <span class="text-lg">${rankIcon}</span>
                <span class="text-sm font-bold" style="color: ${rankColor}; min-width: 20px;">#${rank}</span>
              </div>
              <div class="text-2xl" role="img" aria-label="${member.flag} flag">${member.flag}</div>
              <div class="flex flex-col">
                <span class="font-semibold text-base">${member.display_name || member.username}</span>
                <span class="text-xs" style="color: var(--text-secondary);">@${member.username}</span>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold text-lg" style="color: var(--primary-color);">${member.elo.toFixed(0)}</div>
              <div class="text-xs" style="color: var(--text-secondary);">ELO Rating</div>
            </div>
          </div>
        `;
      }).join('');

      // Show team content
      document.getElementById('team-detail-loading').classList.add('hidden');
      document.getElementById('team-detail-error').classList.add('hidden');
      document.getElementById('team-detail-content').classList.remove('hidden');
    }

    // Load user profile
    function loadUserProfile() {
      if (!currentUser) return;

      // Load profile form
      document.getElementById('profile-username').value = currentUser.username || '';
      document.getElementById('profile-team').value = currentUser.team || 'Independent';
      document.getElementById('profile-weight').value = currentUser.weight || '';
      document.getElementById('profile-gender').value = currentUser.gender || '';

      // Load user PRs and progress charts
      loadUserPRs();
      loadProgressCharts();
    }

    function loadUserPRs() {
      if (!currentUser) return;

      fetch(`${API_BASE}/api/user/${currentUser.username}/posts`)
        .then(res => res.json())
        .then(data => {
          const postsContainer = document.getElementById('user-posts');
          if (data.length === 0) {
            postsContainer.innerHTML = '<p style="color: var(--text-secondary)" class="text-center py-8">No posts yet. Submit your first PR!</p>';
            return;
          }

          postsContainer.innerHTML = data.map(post => {
            const liftEmoji = post.lift_type === 'bench' ? 'üèãÔ∏è' : post.lift_type === 'squat' ? 'ü¶µ' : 'üèãÔ∏è‚Äç‚ôÇÔ∏è';
            return `
              <div class="flex items-center justify-between p-4 border" style="border-color: var(--border); border-radius: 0.5rem;">
                <div class="flex items-center gap-4">
                  <span class="text-2xl">${liftEmoji}</span>
                  <div>
                    <div class="font-semibold text-lg">${post.weight}kg ${post.lift_type}</div>
                    <div class="text-sm" style="color: var(--text-secondary)">${new Date(post.created_at).toLocaleDateString()}</div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <a href="${post.video_url}" target="_blank" rel="noopener noreferrer" class="btn btn-outline btn-sm">Watch</a>
                  <button onclick="deletePost(${post.id})" class="btn btn-danger btn-sm">Delete</button>
                </div>
              </div>
            `;
          }).join('');
        })
        .catch(err => {
          console.error('Error loading user posts:', err);
          const postsContainer = document.getElementById('user-posts');
          postsContainer.innerHTML = '<p style="color: var(--error)" class="text-center py-8">Error loading posts.</p>';
        });
    }

    // Load progress charts
    function loadProgressCharts() {
      if (!currentUser) return;
      
      fetch(`${API_BASE}/api/user/${currentUser.username}/progress`)
        .then(res => res.json())
        .then(data => {
          // Render charts for each lift type
          renderProgressChart('bench', data.bench);
          renderProgressChart('squat', data.squat);
          renderProgressChart('deadlift', data.deadlift);
        })
        .catch(err => {
          console.error('Error loading progress data:', err);
        });
    }

    // Render progress chart (smoother curve, gradient fill, gridlines)
    function renderProgressChart(liftType, progressData) {
      const canvas = document.getElementById(`${liftType}-chart`);
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      const width = rect.width;
      const height = rect.height;
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);
      
      if (!progressData || progressData.length === 0) {
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data yet', width / 2, height / 2);
        document.getElementById(`${liftType}-current`).textContent = 'Current: --kg';
        document.getElementById(`${liftType}-trend`).textContent = '--';
        return;
      }
      
      // Prepare data
      const weights = progressData.map(d => d.weight);
      const minWeight = Math.min(...weights);
      const maxWeight = Math.max(...weights);
      const weightRange = maxWeight - minWeight || 1;
      
      const padding = 28;
      const chartWidth = width - 2 * padding;
      const chartHeight = height - 2 * padding;
      
      const currentWeight = weights[weights.length - 1];
      const previousWeight = weights.length > 1 ? weights[weights.length - 2] : currentWeight;
      const delta = currentWeight - previousWeight;
      const trend = `${delta >= 0 ? '+' : ''}${delta.toFixed(1)}kg`;
      document.getElementById(`${liftType}-current`).textContent = `Current: ${currentWeight}kg`;
      document.getElementById(`${liftType}-trend`).textContent = trend;
      
      // Colors
      const rootStyle = getComputedStyle(document.documentElement);
      const primary = (rootStyle.getPropertyValue('--primary-color') || '#ea580c').trim();
      const textSecondary = (rootStyle.getPropertyValue('--text-secondary') || '#6b7280').trim();
      const border = (rootStyle.getPropertyValue('--border') || '#e5e7eb').trim();
      
      // Gridlines
      ctx.strokeStyle = border;
      ctx.lineWidth = 1;
      ctx.beginPath();
      const gridLines = 4;
      for (let i = 0; i <= gridLines; i++) {
        const y = padding + (i / gridLines) * chartHeight;
        ctx.moveTo(padding, y);
        ctx.lineTo(padding + chartWidth, y);
      }
      ctx.stroke();
      
      // Points as coordinates
      const linePoints = progressData.map((point, index) => {
        const x = padding + (index / (progressData.length - 1 || 1)) * chartWidth;
        const y = padding + (1 - (point.weight - minWeight) / weightRange) * chartHeight;
        return { x, y };
      });
      
      // Gradient under curve
      const gradient = ctx.createLinearGradient(0, padding, 0, padding + chartHeight);
      gradient.addColorStop(0, primary + '33');
      gradient.addColorStop(1, primary + '00');
      
      // Catmull-Rom to Bezier smoothing
      function getControlPoints(p0, p1, p2, p3, t = 0.2) {
        const d1 = Math.hypot(p1.x - p0.x, p1.y - p0.y);
        const d2 = Math.hypot(p2.x - p1.x, p2.y - p1.y);
        const d3 = Math.hypot(p3.x - p2.x, p3.y - p2.y);
        const b1 = d1 ? t * d1 / (d1 + d2) : 0;
        const b2 = d3 ? t * d3 / (d2 + d3) : 0;
        const cp1x = p1.x + b1 * (p2.x - p0.x);
        const cp1y = p1.y + b1 * (p2.y - p0.y);
        const cp2x = p2.x - b2 * (p3.x - p1.x);
        const cp2y = p2.y - b2 * (p3.y - p1.y);
        return { cp1x, cp1y, cp2x, cp2y };
      }
      
      // Filled area
      ctx.beginPath();
      ctx.moveTo(linePoints[0].x, linePoints[0].y);
      for (let i = 0; i < linePoints.length - 1; i++) {
        const p0 = linePoints[Math.max(0, i - 1)];
        const p1 = linePoints[i];
        const p2 = linePoints[i + 1];
        const p3 = linePoints[Math.min(linePoints.length - 1, i + 2)];
        const { cp1x, cp1y, cp2x, cp2y } = getControlPoints(p0, p1, p2, p3);
        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
      }
      ctx.lineTo(padding + chartWidth, padding + chartHeight);
      ctx.lineTo(padding, padding + chartHeight);
      ctx.closePath();
      ctx.fillStyle = gradient;
      ctx.fill();
      
      // Stroke curve
      ctx.beginPath();
      ctx.moveTo(linePoints[0].x, linePoints[0].y);
      for (let i = 0; i < linePoints.length - 1; i++) {
        const p0 = linePoints[Math.max(0, i - 1)];
        const p1 = linePoints[i];
        const p2 = linePoints[i + 1];
        const p3 = linePoints[Math.min(linePoints.length - 1, i + 2)];
        const { cp1x, cp1y, cp2x, cp2y } = getControlPoints(p0, p1, p2, p3);
        ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
      }
      ctx.strokeStyle = primary;
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // Points
      ctx.fillStyle = primary;
      linePoints.forEach(({ x, y }) => {
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
      });
      
      // Min/Max labels
      ctx.fillStyle = textSecondary;
      ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial';
      ctx.textAlign = 'left';
      ctx.fillText(`${minWeight}kg`, 8, height - 6);
      ctx.textAlign = 'right';
      ctx.fillText(`${maxWeight}kg`, width - 8, 14);
    }

    // Edit post function
    function editPost(postId, currentLiftType, currentWeight) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content card">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold">Edit Post</h3>
            <button onclick="this.closest('.modal').remove()" class="btn btn-outline btn-sm">‚úï</button>
          </div>
          <form id="edit-post-form">
            <div class="form-group">
              <label class="form-label">Lift Type</label>
              <select id="edit-lift-type" class="form-input">
                <option value="bench" ${currentLiftType === 'bench' ? 'selected' : ''}>Bench Press</option>
                <option value="deadlift" ${currentLiftType === 'deadlift' ? 'selected' : ''}>Deadlift</option>
                <option value="squat" ${currentLiftType === 'squat' ? 'selected' : ''}>Squat</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Weight (kg)</label>
              <input type="number" id="edit-weight" value="${currentWeight}" step="0.5" min="0" class="form-input" required>
            </div>
            <div class="flex gap-3">
              <button type="submit" class="btn btn-primary flex-1">Update Post</button>
              <button type="button" onclick="this.closest('.modal').remove()" class="btn btn-outline flex-1">Cancel</button>
            </div>
          </form>
        </div>
      `;
      
      modal.querySelector('#edit-post-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const liftType = document.getElementById('edit-lift-type').value;
        const weight = document.getElementById('edit-weight').value;
        
        fetch(`${API_BASE}/api/posts/${postId}`, {
          method: 'PUT',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentUser.access_token}`
          },
          body: JSON.stringify({
            username: currentUser.username,
            lift_type: liftType,
            weight: parseFloat(weight)
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            alert('Error updating post: ' + data.error);
          } else {
            alert('Post updated successfully!');
            modal.remove();
            loadUserProfile();
            loadLeaderboard();
          }
        })
        .catch(err => {
          alert('Error updating post.');
        });
      });
      
      document.body.appendChild(modal);
    }

    // Delete post function
    function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
      }
      
      fetch(`${API_BASE}/api/posts/${postId}`, {
        method: 'DELETE',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentUser.access_token}`
        },
        body: JSON.stringify({ username: currentUser.username })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert('Error deleting post: ' + data.error);
        } else {
          alert('Post deleted successfully!');
          loadUserProfile();
          loadLeaderboard();
        }
      })
      .catch(err => {
        alert('Error deleting post.');
      });
    }

    // Handle profile update
    function handleProfileUpdate(e) {
      e.preventDefault();
      
      const newUsername = document.getElementById('profile-username').value;
      const team = document.getElementById('profile-team').value;
      const weight = document.getElementById('profile-weight').value;
      const gender = document.getElementById('profile-gender').value;
      
      if (!newUsername || !team || !gender) {
        alert('Username, team, and gender are required');
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Updating...';
      submitBtn.disabled = true;
      
      fetch(`${API_BASE}/api/profile/update`, {
        method: 'PUT',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${currentUser.access_token}`
        },
        body: JSON.stringify({
          username: currentUser.username,
          new_username: newUsername,
          team: team,
          weight: weight ? parseFloat(weight) : null,
          gender: gender
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert('Update failed: ' + data.error);
        } else {
          // Update currentUser with new data
          currentUser = { ...currentUser, ...data };
          localStorage.setItem('gymrank_user', JSON.stringify(currentUser));
          
          // Update UI
          updateUIForLoggedInUser();
          
          alert('Profile updated successfully!');
          loadUserProfile();
          loadLeaderboard();
        }
      })
      .catch(err => {
        alert('Update failed. Please try again.');
      })
      .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    }

    // Handle combined PR submission
    function handleCombinedPR(e) {
      e.preventDefault();
      
      const username = currentUser.username;
      const lift_type = document.getElementById('lift-type').value;
      const weightInput = document.getElementById('weight');
      const weight = parseFloat(weightInput.value);
      const instagramUrl = document.getElementById('instagram-url').value.trim();
      
      // Enhanced validation
      if (!lift_type) {
        showAlert('Please select a lift type', 'error');
        document.getElementById('lift-type').focus();
        return;
      }
      
      if (!weight || isNaN(weight)) {
        showAlert('Please enter a valid weight', 'error');
        weightInput.focus();
        return;
      }
      
      if (weight < 1 || weight > 600) {
        showAlert('Weight must be between 1kg and 600kg', 'error');
        weightInput.focus();
        return;
      }
      
      if (!instagramUrl) {
        showAlert('Instagram video link is required to submit a PR', 'error');
        document.getElementById('instagram-url').focus();
        return;
      }
      
      // Enhanced Instagram URL validation
      const instagramPattern = /^https:\/\/www\.instagram\.com\/(reel|p|tv)\/[A-Za-z0-9_-]+\/?(\?.*)?$/;
      if (!instagramPattern.test(instagramUrl)) {
        showAlert('Please enter a valid Instagram URL (reel, post, or IGTV)', 'error');
        document.getElementById('instagram-url').focus();
        return;
      }
      
      // Show loading state
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="mr-2">‚è≥</span>Submitting PR...';
      submitBtn.disabled = true;
      
      // Submit with Instagram URL
      const formData = new FormData();
      formData.append('username', username);
      formData.append('lift_type', lift_type);
      formData.append('weight', weight);
      formData.append('instagram_url', instagramUrl);
      
      fetch(`${API_BASE}/api/submit_pr`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${currentUser.access_token}`
        },
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          let errorMessage = data.error;
          if (errorMessage.includes('Invalid Instagram URL')) {
            errorMessage = 'The Instagram URL format is not valid. Please check and try again.';
          } else if (errorMessage.includes('Database error')) {
            errorMessage = 'Failed to save your PR. Please try again.';
          }
          showAlert('Submission failed: ' + errorMessage, 'error');
        } else {
          showAlert('üéâ PR submitted successfully! Your lift has been added to the leaderboard.', 'success');
          
          // Clear form and reset to defaults
          document.getElementById('combined-pr-form').reset();
          document.getElementById('lift-type').value = 'bench'; // Reset to default
          
          // Reload relevant sections
          if (currentSection === 'videos') {
            loadVideos();
          }
          if (currentSection === 'leaderboard') {
            loadLeaderboard();
          }
          if (currentSection === 'home') {
            loadLeaderboard(); // For stats update
          }
          if (currentUser) {
            loadProgressCharts();
          }
        }
      })
      .catch(err => {
        console.error('PR submission error:', err);
        showAlert('Failed to submit PR. Please check your connection and try again.', 'error');
      })
      .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      });
    }

    // Initialize all event listeners
    function initializeEventListeners() {
      const combinedPrForm = document.getElementById('combined-pr-form');
      const profileSettingsForm = document.getElementById('profile-settings-form');
      
      if (combinedPrForm) {
        combinedPrForm.addEventListener('submit', handleCombinedPR);
        
        // Add real-time validation for weight input
        const weightInput = document.getElementById('weight');
        if (weightInput) {
          weightInput.addEventListener('input', function() {
            const weight = parseFloat(this.value);
            if (this.value && (isNaN(weight) || weight < 1 || weight > 600)) {
              this.setCustomValidity('Weight must be between 1kg and 600kg');
            } else {
              this.setCustomValidity('');
            }
          });
        }
        
        // Add real-time validation for Instagram URL
        const instagramInput = document.getElementById('instagram-url');
        if (instagramInput) {
          instagramInput.addEventListener('input', function() {
            const url = this.value.trim();
            if (url) {
              const instagramPattern = /^https:\/\/www\.instagram\.com\/(reel|p|tv)\/[A-Za-z0-9_-]+\/?(\?.*)?$/;
              if (!instagramPattern.test(url)) {
                this.setCustomValidity('Please enter a valid Instagram URL (reel, post, or IGTV)');
              } else {
                this.setCustomValidity('');
              }
            } else {
              this.setCustomValidity('');
            }
          });
        }
      }
      
      if (profileSettingsForm) {
        profileSettingsForm.addEventListener('submit', handleProfileUpdate);
      }
    }

    // Load initial data and check session on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializeTheme();
      initializeEventListeners();
      checkUserSession();
      
      // Handle special hashes (login/register modals)
      handleSpecialHashes();
      
      // Handle initial URL routing
      const initialSection = getHashSection() || 'home';
      currentSection = initialSection; // Set initial current section
      showSection(initialSection, false, false); // Don't add initial section to history
      
      loadLeaderboard();
    });
  </script>
  <!-- Unregister service worker and clear cache to fix issues -->
  <script>
    // Clear service worker and cache
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
          console.log('üóëÔ∏è Service worker unregistered');
        }
      });
    }
    
    // Clear cache storage
    if ('caches' in window) {
      caches.keys().then(function(names) {
        names.forEach(function(name) {
          caches.delete(name);
          console.log('üßπ Cache cleared:', name);
        });
      });
    }
    
    console.log('‚úÖ Navigation styling should work without caching interference');
  </script>
</body>
</html>
